Bootstrap: docker
From: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

%environment
    export PYTHONUNBUFFERED=1
    export PIP_NO_CACHE_DIR=1
    export PYTHONPATH=/workspace

%post
    # Install Python 3.10
    apt-get update && apt-get install -y \
        python3.10 \
        python3.10-dev \
        python3-pip \
        git \
        build-essential \
        wget \
        curl \
        libglib2.0-0 \
        libgl1 \
        ca-certificates \
        && ln -sf /usr/bin/python3.10 /usr/bin/python \
        && ln -sf /usr/bin/python3.10 /usr/bin/python3 \
        && rm -rf /var/lib/apt/lists/*

    # Upgrade pip
    pip install --upgrade pip setuptools wheel

    # Install geospatial stack
    pip install \
        numpy \
        rasterio==1.3.10 \
        fiona==1.9.5 \
        geopandas==0.14.4 \
        shapely==2.0.4 \
        pyproj==3.6.1 \
        rtree==1.3.0 \
        affine

    # Install PyTorch with CUDA 11.8
    pip install \
        torch==2.1.2 \
        torchvision==0.16.2 \
        torchaudio==2.1.2 \
        --index-url https://download.pytorch.org/whl/cu118

    # Install detectron2 from source
    pip install --no-build-isolation \
        git+https://github.com/facebookresearch/detectron2.git@v0.6

    # Install utilities
    pip install \
        opencv-python \
        wget \
        requests \
        matplotlib \
        cython \
        pycocotools \
        duckdb \
        pyarrow \
        scikit-image \
        tqdm

    # Install detectree2
    pip install --no-build-isolation \
        git+https://github.com/PatBall1/detectree2.git

%runscript
    exec /bin/bash "$@"
